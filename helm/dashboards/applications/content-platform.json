{"annotations":{"list":[{"builtIn":1,"datasource":{"type":"grafana","uid":"-- Grafana --"},"enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations & Alerts","type":"dashboard"}]},"editable":true,"fiscalYearStartMonth":0,"graphTooltip":1,"id":null,"links":[{"asDropdown":false,"icon":"dashboard","includeVars":true,"keepTime":true,"tags":[],"targetBlank":false,"title":"Back to Overview","type":"link","url":"/d/infrastructure-overview"},{"asDropdown":false,"icon":"external link","includeVars":true,"keepTime":true,"tags":[],"targetBlank":true,"title":"RabbitMQ Dashboard","type":"link","url":"/d/rabbitmq"}],"liveNow":false,"panels":[{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"Content Platform environment availability","fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[{"options":{"0":{"color":"red","index":0,"text":"DOWN"},"1":{"color":"green","index":1,"text":"UP"}},"type":"value"}],"thresholds":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"green","value":1}]}}},"gridPos":{"y":0,"h":4,"w":6,"x":0},"id":1,"options":{"colorMode":"background","graphMode":"none","justifyMode":"center","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"value"},"pluginVersion":"10.0.0","targets":[{"expr":"min(kube_deployment_status_replicas_available{namespace=\"$namespace\"})","refId":"A"}],"title":"Environment","type":"stat"},{"gridPos":{"y":0,"h":4,"w":6,"x":6},"title":"Active Pods","type":"stat","fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"green","value":3}]}}},"description":"Total running pods in namespace","id":30,"targets":[{"expr":"count(kube_pod_info{namespace=\"$namespace\", pod=~\"web-.*|websocket-.*|redis-.*|content-platform-domain-controller-.*\"})","refId":"A"}],"options":{"colorMode":"background","graphMode":"none","textMode":"value"},"datasource":{"type":"prometheus","uid":"prometheus"}},{"collapsed":false,"id":100,"gridPos":{"y":4,"h":1,"w":24,"x":0},"title":"Web Service (Next.js)","type":"row"},{"gridPos":{"y":5,"h":8,"w":8,"x":0},"title":"CPU Usage","type":"timeseries","fieldConfig":{"defaults":{"custom":{"showPoints":"never","lineWidth":2,"fillOpacity":20,"drawStyle":"line"},"unit":"percentunit","color":{"mode":"palette-classic"}}},"description":"CPU usage rate per pod","id":22,"targets":[{"refId":"A","legendFormat":"{{pod}}","expr":"rate(process_cpu_user_seconds_total{namespace=\"$namespace\", pod=~\"web-.*\"}[5m])"}],"options":{"legend":{"placement":"bottom","calcs":["mean","max"],"displayMode":"table"}},"datasource":{"type":"prometheus","uid":"prometheus"}},{"gridPos":{"y":5,"h":8,"w":8,"x":8},"title":"Heap Memory","type":"timeseries","fieldConfig":{"defaults":{"custom":{"showPoints":"never","lineWidth":2,"fillOpacity":10,"drawStyle":"line","axisPlacement":"auto"},"unit":"bytes","color":{"mode":"palette-classic"}}},"description":"Node.js heap memory usage - process resident memory","id":21,"targets":[{"refId":"A","legendFormat":"{{pod}}","expr":"process_resident_memory_bytes{namespace=\"$namespace\", pod=~\"web-.*\"}"}],"options":{"legend":{"placement":"bottom","calcs":["last","max"],"displayMode":"table"}},"datasource":{"type":"prometheus","uid":"prometheus"}},{"gridPos":{"y":5,"h":8,"w":8,"x":16},"title":"Event Loop Lag","type":"timeseries","fieldConfig":{"defaults":{"custom":{"showPoints":"never","lineWidth":2},"unit":"s","color":{"mode":"palette-classic"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":0.1},{"color":"red","value":0.5}]}}},"description":"Node.js event loop lag - high values indicate blocking operations","id":23,"targets":[{"refId":"A","legendFormat":"{{pod}}","expr":"nodejs_eventloop_lag_mean_seconds{namespace=\"$namespace\", pod=~\"web-.*\"} or nodejs_eventloop_lag_seconds{namespace=\"$namespace\", pod=~\"web-.*\"}"}],"options":{"legend":{"placement":"bottom","calcs":["last","max"],"displayMode":"table"}},"datasource":{"type":"prometheus","uid":"prometheus"}},{"collapsed":false,"id":101,"gridPos":{"y":13,"h":1,"w":24,"x":0},"title":"Websocket Service (Socket.io)","type":"row"},{"gridPos":{"y":14,"h":8,"w":8,"x":0},"fieldConfig":{"defaults":{"custom":{"showPoints":"never","lineWidth":2,"fillOpacity":20,"drawStyle":"line"},"unit":"percentunit","color":{"mode":"palette-classic"}}},"id":40,"targets":[{"refId":"A","legendFormat":"{{pod}}","expr":"rate(process_cpu_user_seconds_total{namespace=\"$namespace\", pod=~\"websocket-.*\"}[5m])"}],"options":{"legend":{"placement":"bottom","calcs":["mean","max"],"displayMode":"table"}},"type":"timeseries","datasource":{"type":"prometheus","uid":"prometheus"},"title":"CPU Usage"},{"gridPos":{"y":14,"h":8,"w":8,"x":8},"fieldConfig":{"defaults":{"custom":{"fillOpacity":10,"lineWidth":2},"unit":"bytes","color":{"mode":"palette-classic"}}},"id":41,"targets":[{"refId":"A","legendFormat":"{{pod}}","expr":"process_resident_memory_bytes{namespace=\"$namespace\", pod=~\"websocket-.*\"}"}],"options":{"legend":{"placement":"bottom","calcs":["last","max"],"displayMode":"table"}},"type":"timeseries","datasource":{"type":"prometheus","uid":"prometheus"},"title":"Heap Memory"},{"gridPos":{"y":14,"h":8,"w":8,"x":16},"fieldConfig":{"defaults":{"custom":{"lineWidth":2},"unit":"s","color":{"mode":"palette-classic"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":0.1},{"color":"red","value":0.5}]}}},"id":42,"targets":[{"refId":"A","legendFormat":"{{pod}}","expr":"nodejs_eventloop_lag_mean_seconds{namespace=\"$namespace\", pod=~\"websocket-.*\"} or nodejs_eventloop_lag_seconds{namespace=\"$namespace\", pod=~\"websocket-.*\"}"}],"options":{"legend":{"placement":"bottom","calcs":["last","max"],"displayMode":"table"}},"type":"timeseries","datasource":{"type":"prometheus","uid":"prometheus"},"title":"Event Loop Lag"},{"gridPos":{"y":22,"h":4,"w":8,"x":0},"title":"Active Connections","type":"stat","fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":10},{"color":"orange","value":50},{"color":"red","value":100}]}}},"description":"Total active WebSocket connections","id":43,"targets":[{"expr":"websocket_connections_total{namespace=\"$namespace\", pod=~\"websocket-.*\"}","refId":"A"}],"options":{"colorMode":"background","graphMode":"area","textMode":"value_and_name"},"datasource":{"type":"prometheus","uid":"prometheus"}},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"New WebSocket connections per second","fieldConfig":{"defaults":{"custom":{"lineWidth":2,"fillOpacity":20,"drawStyle":"line"},"unit":"cps","color":{"mode":"palette-classic"}}},"gridPos":{"h":8,"w":8,"x":0,"y":26},"id":44,"options":{"legend":{"placement":"bottom","calcs":["mean","max"],"displayMode":"table"}},"targets":[{"expr":"rate(websocket_connections_established_total{namespace=\"$namespace\", pod=~\"websocket-.*\"}[5m]) or vector(0)","refId":"A","legendFormat":"{{pod}}"}],"title":"Connection Rate","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"WebSocket disconnections per second by reason","fieldConfig":{"defaults":{"custom":{"lineWidth":2,"fillOpacity":20,"drawStyle":"line"},"unit":"cps","color":{"mode":"palette-classic"}}},"gridPos":{"h":8,"w":8,"x":8,"y":26},"id":45,"options":{"legend":{"placement":"bottom","calcs":["mean","max"],"displayMode":"table"}},"targets":[{"expr":"rate(websocket_connections_closed_total{namespace=\"$namespace\", pod=~\"websocket-.*\"}[5m]) or vector(0)","refId":"A","legendFormat":"{{reason}}"}],"title":"Disconnection Rate","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"Number of active pipeline rooms (max 20 expected)","fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":15},{"color":"orange","value":20},{"color":"red","value":25}]},"unit":"short","max":30}},"gridPos":{"h":8,"w":8,"x":16,"y":26},"id":46,"options":{"colorMode":"background","graphMode":"area","textMode":"value_and_name"},"targets":[{"expr":"websocket_rooms_total{namespace=\"$namespace\", pod=~\"websocket-.*\"}","refId":"A","legendFormat":"Active Rooms"}],"title":"Active Rooms","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"Messages published to Redis PubSub channels per second","fieldConfig":{"defaults":{"custom":{"lineWidth":2,"fillOpacity":10,"drawStyle":"line"},"unit":"reqps","color":{"mode":"palette-classic"}}},"gridPos":{"h":8,"w":12,"x":0,"y":34},"id":47,"options":{"legend":{"placement":"bottom","calcs":["mean","max"],"displayMode":"table"}},"targets":[{"expr":"rate(redis_commands_total{namespace=\"$namespace\",cmd=\"publish\"}[5m]) or vector(0)","refId":"A","legendFormat":"Messages/sec"}],"title":"PubSub Message Rate","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"WebSocket broadcasts sent per second","fieldConfig":{"defaults":{"custom":{"lineWidth":2,"fillOpacity":10,"drawStyle":"line"},"unit":"reqps","color":{"mode":"palette-classic"}}},"gridPos":{"h":8,"w":12,"x":12,"y":34},"id":48,"options":{"legend":{"placement":"bottom","calcs":["mean","max"],"displayMode":"table"}},"targets":[{"expr":"rate(websocket_broadcasts_total{namespace=\"$namespace\", pod=~\"websocket-.*\"}[5m]) or vector(0)","refId":"A","legendFormat":"{{event_type}}"}],"title":"Broadcast Rate","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"WebSocket authentication failures","fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":1},{"color":"red","value":5}]},"unit":"short"}},"gridPos":{"h":8,"w":8,"x":0,"y":42},"id":49,"options":{"colorMode":"background","graphMode":"area","textMode":"value_and_name"},"targets":[{"expr":"increase(websocket_auth_failures_total{namespace=\"$namespace\", pod=~\"websocket-.*\"}[5m]) or vector(0)","refId":"A","legendFormat":"Auth Failures (5m)"}],"title":"Auth Failures","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"Failed subscription operations (join/leave/subscribe/unsubscribe)","fieldConfig":{"defaults":{"custom":{"lineWidth":2,"fillOpacity":10,"drawStyle":"line"},"unit":"short","color":{"mode":"palette-classic"}}},"gridPos":{"h":8,"w":16,"x":8,"y":42},"id":50,"options":{"legend":{"placement":"bottom","calcs":["last","max"],"displayMode":"table"}},"targets":[{"expr":"increase(websocket_subscription_errors_total{namespace=\"$namespace\", pod=~\"websocket-.*\"}[5m]) or vector(0)","refId":"A","legendFormat":"{{operation}}"}],"title":"Subscription Errors (5m)","type":"timeseries"},{"collapsed":false,"id":102,"gridPos":{"y":50,"h":1,"w":24,"x":0},"title":"Redis (PubSub)","type":"row"},{"gridPos":{"y":51,"h":8,"w":8,"x":0},"id":50,"title":"Redis Memory Usage","type":"timeseries","datasource":{"type":"prometheus","uid":"prometheus"},"description":"Redis memory usage - includes PubSub buffer memory","fieldConfig":{"defaults":{"custom":{"lineWidth":2,"fillOpacity":10,"drawStyle":"line"},"unit":"bytes","color":{"mode":"palette-classic"}}},"targets":[{"expr":"redis_memory_used_bytes{namespace=\"$namespace\"}","refId":"A","legendFormat":"Used Memory - {{pod}}"},{"expr":"redis_memory_max_bytes{namespace=\"$namespace\"}","refId":"B","legendFormat":"Max Memory - {{pod}}"}],"options":{"legend":{"placement":"bottom","calcs":["last","max"],"displayMode":"table"}}},{"gridPos":{"y":51,"h":8,"w":8,"x":8},"id":51,"title":"Redis Connected Clients","type":"timeseries","datasource":{"type":"prometheus","uid":"prometheus"},"description":"Number of clients connected to Redis (WebSocket pods publishing to PubSub)","fieldConfig":{"defaults":{"custom":{"lineWidth":2,"fillOpacity":10,"drawStyle":"line"},"unit":"short","color":{"mode":"palette-classic"}}},"targets":[{"expr":"redis_connected_clients{namespace=\"$namespace\"}","refId":"A","legendFormat":"{{pod}}"}],"options":{"legend":{"placement":"bottom","calcs":["last","max"],"displayMode":"table"}}},{"gridPos":{"y":59,"h":8,"w":8,"x":0},"id":53,"title":"Redis Operations/sec","type":"timeseries","datasource":{"type":"prometheus","uid":"prometheus"},"description":"Total Redis commands processed per second (PUBLISH, SUBSCRIBE, etc)","fieldConfig":{"defaults":{"custom":{"lineWidth":2,"fillOpacity":20,"drawStyle":"line"},"unit":"ops","color":{"mode":"palette-classic"}}},"targets":[{"expr":"rate(redis_commands_processed_total{namespace=\"$namespace\"}[5m])","refId":"A","legendFormat":"{{pod}}"}],"options":{"legend":{"placement":"bottom","calcs":["mean","max"],"displayMode":"table"}}},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"Number of active PubSub channels (pipeline events)","fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":10},{"color":"orange","value":20},{"color":"red","value":30}]},"unit":"short"}},"gridPos":{"h":8,"w":8,"x":0,"y":67},"id":57,"options":{"colorMode":"background","graphMode":"area","textMode":"value_and_name"},"targets":[{"expr":"redis_pubsub_channels{namespace=\"$namespace\"} or vector(0)","refId":"A","legendFormat":"Active Channels"}],"title":"Active PubSub Channels","type":"stat"},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"Redis pod CPU usage","fieldConfig":{"defaults":{"custom":{"lineWidth":2,"fillOpacity":20,"drawStyle":"line"},"unit":"percentunit","color":{"mode":"palette-classic"}}},"gridPos":{"h":8,"w":8,"x":8,"y":67},"id":58,"options":{"legend":{"placement":"bottom","calcs":["mean","max"],"displayMode":"table"}},"targets":[{"expr":"sum(rate(container_cpu_usage_seconds_total{namespace=\"$namespace\", pod=~\"redis-.*\", container!=\"\", container!=\"POD\"}[5m])) by (pod)","refId":"A","legendFormat":"{{pod}}"}],"title":"Redis CPU Usage","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"Redis pod memory usage","fieldConfig":{"defaults":{"custom":{"lineWidth":2,"fillOpacity":10,"drawStyle":"line"},"unit":"bytes","color":{"mode":"palette-classic"}}},"gridPos":{"h":8,"w":8,"x":16,"y":67},"id":59,"options":{"legend":{"placement":"bottom","calcs":["last","max"],"displayMode":"table"}},"targets":[{"expr":"sum(container_memory_working_set_bytes{namespace=\"$namespace\", pod=~\"redis-.*\", container!=\"\", container!=\"POD\"}) by (pod)","refId":"A","legendFormat":"{{pod}}"}],"title":"Redis Pod Memory Usage","type":"timeseries"},{"collapsed":false,"id":103,"gridPos":{"y":75,"h":1,"w":24,"x":0},"title":"Domain Controller (Go/Kubernetes Controller)","type":"row"},{"gridPos":{"y":76,"h":4,"w":6,"x":0},"fieldConfig":{"defaults":{"mappings":[{"type":"value","options":{"0":{"text":"DOWN","color":"red","index":0},"1":{"text":"UP","color":"green","index":1}}}],"thresholds":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"green","value":1}]},"color":{"mode":"thresholds"}}},"id":60,"targets":[{"expr":"kube_deployment_status_replicas_available{namespace=\"$namespace\", deployment=~\"content-platform-domain-controller.*\"}","refId":"A"}],"options":{"textMode":"value","colorMode":"background"},"type":"stat","datasource":{"type":"prometheus","uid":"prometheus"},"title":"Controller Status"},{"gridPos":{"y":80,"h":8,"w":9,"x":0},"fieldConfig":{"defaults":{"custom":{"fillOpacity":10,"lineWidth":2},"unit":"bytes","color":{"mode":"palette-classic"}}},"id":61,"targets":[{"refId":"A","legendFormat":"{{pod}}","expr":"sum(container_memory_working_set_bytes{namespace=\"$namespace\", pod=~\"content-platform-domain-controller.*\", container!=\"\", container!=\"POD\"}) by (pod)"}],"options":{"legend":{"placement":"bottom","calcs":["last","max"],"displayMode":"table"}},"type":"timeseries","datasource":{"type":"prometheus","uid":"prometheus"},"title":"Memory Usage"},{"gridPos":{"y":80,"h":8,"w":9,"x":9},"fieldConfig":{"defaults":{"custom":{"fillOpacity":20,"lineWidth":2},"unit":"percentunit","color":{"mode":"palette-classic"}}},"id":62,"targets":[{"refId":"A","legendFormat":"{{pod}}","expr":"sum(rate(container_cpu_usage_seconds_total{namespace=\"$namespace\", pod=~\"content-platform-domain-controller.*\", container!=\"\", container!=\"POD\"}[5m])) by (pod)"}],"options":{"legend":{"placement":"bottom","calcs":["mean","max"],"displayMode":"table"}},"type":"timeseries","datasource":{"type":"prometheus","uid":"prometheus"},"title":"CPU Usage"},{"gridPos":{"y":80,"h":8,"w":6,"x":18},"title":"Pod Restarts (24h)","type":"stat","fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":1},{"color":"red","value":5}]}}},"description":"Controller pod restarts in last 24 hours","id":63,"targets":[{"expr":"sum(increase(kube_pod_container_status_restarts_total{namespace=\"$namespace\", pod=~\"content-platform-domain-controller.*\"}[24h]))","refId":"A"}],"options":{"textMode":"value","colorMode":"background"},"datasource":{"type":"prometheus","uid":"prometheus"}},{"datasource":{"type":"prometheus","uid":"prometheus"},"description":"Let's Encrypt certificate issuance for this platform (7-day rolling window, 50 cert limit)","fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"yellow","value":25},{"color":"orange","value":40},{"color":"red","value":50}]},"unit":"short","max":50}},"gridPos":{"h":8,"w":12,"x":0,"y":88},"id":70,"options":{"colorMode":"background","graphMode":"area","justifyMode":"center","orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"value_and_name"},"pluginVersion":"10.0.0","targets":[{"expr":"count(changes(certmanager_certificate_ready_status{condition=\"True\", namespace=\"$namespace\"}[7d]) > 0)","refId":"A","legendFormat":"Issued (7d)"}],"title":"Let's Encrypt Quota Usage (Domain Controller)","type":"stat"}],"refresh":"30s","schemaVersion":38,"style":"dark","tags":["copperiq","content-platform","n8n"],"templating":{"list":[{"queryValue":"","multi":false,"type":"custom","label":"Environment","description":"Select Content Platform environment","options":[{"value":"content-platform-accept","text":"content-platform-accept","selected":true},{"value":"content-platform-prod","text":"content-platform-prod","selected":false}],"includeAll":false,"query":"content-platform-accept,content-platform-prod","skipUrlSync":false,"name":"namespace","hide":0,"current":{"value":"content-platform-accept","text":"content-platform-accept","selected":false}},{"current":{"selected":false,"text":"Prometheus","value":"Prometheus"},"hide":0,"includeAll":false,"label":"Datasource","multi":false,"name":"DS_PROMETHEUS","options":[],"query":"prometheus","refresh":1,"regex":"","skipUrlSync":false,"type":"datasource"}]},"time":{"from":"now-1h","to":"now"},"timepicker":{},"timezone":"Europe/Amsterdam","title":"Content Platform","uid":"content-platform","version":1,"weekStart":"monday","folderUid":"applications","meta":{"folderTitle":"Content Platform"}}