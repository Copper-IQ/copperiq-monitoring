apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-alert-letsencrypt-rate-limits
  namespace: observability
  labels:
    grafana_alert: "1"
data:
  letsencrypt-rate-limits.yaml: |
    apiVersion: 1
    groups:
      - orgId: 1
        name: Let's Encrypt Rate Limits
        folder: Certificates
        interval: 5m
        rules:
          - uid: letsencrypt-rate-limit-warning
            title: Let's Encrypt Rate Limit Warning (>50%)
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 604800
                  to: 0
                datasourceUid: prometheus
                model:
                  expr: |
                    count(
                      count_over_time(
                        certmanager_certificate_ready_status{condition="True"}[7d]
                      ) 
                      and
                      changes(certmanager_certificate_ready_status{condition="True"}[7d]) > 0
                    )
                  refId: A
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: B
                relativeTimeRange:
                  from: 0
                  to: 0
                datasourceUid: __expr__
                model:
                  type: math
                  expression: $A
                  refId: B
              - refId: C
                relativeTimeRange:
                  from: 0
                  to: 0
                datasourceUid: __expr__
                model:
                  type: threshold
                  expression: B
                  conditions:
                    - evaluator:
                        params:
                          - 25
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                          - C
                      type: query
                  refId: C
            noDataState: OK
            execErrState: Alerting
            for: 10m
            annotations:
              summary: "Let's Encrypt certificate issuance approaching rate limit"
              description: |
                **WARNING: {{ $values.B.Value }} certificates issued in the last 7 days**
                
                Let's Encrypt rate limit: 50 certificates per week
                Current usage: {{ $values.B.Value }}/50 ({{ $values.B.Value | humanizePercentage "50" }}%)
                
                **Why this matters:**
                - Content Platform whitelabeling depends on automatic certificate issuance
                - Hitting the rate limit blocks new custom domains for up to 7 days
                - This is a business-critical feature
                
                **Immediate Actions:**
                1. Review recent certificate requests in cert-manager logs
                2. Check for certificate churn (unnecessary renewals)
                3. Identify if domains are being deleted and recreated
                4. Consider staging environment using Let's Encrypt staging (unlimited)
                
                **Investigation:**
                ```bash
                # List certificates issued in last 7 days
                kubectl get certificates --all-namespaces -o json | jq -r '.items[] | select(.status.renewalTime != null) | select(.status.renewalTime | fromdateiso8601 > (now - 604800)) | [.metadata.namespace, .metadata.name, .status.renewalTime] | @tsv'
                
                # Check cert-manager logs for issuance
                kubectl logs -n cert-manager -l app.kubernetes.io/name=cert-manager --since=7d | grep "certificate issued"
                ```
                
                **Prevention:**
                - Implement certificate reuse for domain changes
                - Add validation before domain creation
                - Use Let's Encrypt staging for testing
              runbook_url: "https://github.com/Copper-IQ/copperiq-monitoring/blob/main/docs/runbooks/letsencrypt-rate-limit.md"
            labels:
              severity: warning
              component: cert-manager
              category: certificates
              business_impact: high
            isPaused: false

          - uid: letsencrypt-rate-limit-critical
            title: Let's Encrypt Rate Limit Critical (>80%)
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 604800
                  to: 0
                datasourceUid: prometheus
                model:
                  expr: |
                    count(
                      count_over_time(
                        certmanager_certificate_ready_status{condition="True"}[7d]
                      ) 
                      and
                      changes(certmanager_certificate_ready_status{condition="True"}[7d]) > 0
                    )
                  refId: A
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: B
                relativeTimeRange:
                  from: 0
                  to: 0
                datasourceUid: __expr__
                model:
                  type: math
                  expression: $A
                  refId: B
              - refId: C
                relativeTimeRange:
                  from: 0
                  to: 0
                datasourceUid: __expr__
                model:
                  type: threshold
                  expression: B
                  conditions:
                    - evaluator:
                        params:
                          - 40
                        type: gt
                      operator:
                        type: and
                      query:
                        params:
                          - C
                      type: query
                  refId: C
            noDataState: OK
            execErrState: Alerting
            for: 5m
            annotations:
              summary: "CRITICAL: Let's Encrypt rate limit almost reached"
              description: |
                **CRITICAL: {{ $values.B.Value }} certificates issued in the last 7 days**
                
                Let's Encrypt rate limit: 50 certificates per week
                Current usage: {{ $values.B.Value }}/50 ({{ $values.B.Value | humanizePercentage "50" }}%)
                Remaining: {{ 50 - $values.B.Value }} certificates
                
                **IMMEDIATE IMPACT:**
                - New custom domain requests will FAIL when limit is reached
                - Customers cannot add whitelabel domains
                - Business-critical feature will be offline for up to 7 days
                
                **STOP ALL NON-ESSENTIAL CERTIFICATE REQUESTS**
                
                **Emergency Actions:**
                1. Notify product/engineering teams immediately
                2. Pause any testing/staging domain creation
                3. Implement manual approval for new domain requests
                4. Prepare customer communication about delays
                5. Switch staging/dev to Let's Encrypt staging environment
                
                **Root Cause Investigation:**
                - Check for certificate deletion/recreation loops
                - Review domain-controller logs for repeated requests
                - Identify if testing is consuming production quota
              runbook_url: "https://github.com/Copper-IQ/copperiq-monitoring/blob/main/docs/runbooks/letsencrypt-rate-limit.md"
            labels:
              severity: critical
              component: cert-manager
              category: certificates
              business_impact: critical
            isPaused: false

          - uid: letsencrypt-rate-limit-blocked
            title: Let's Encrypt Rate Limit Reached
            condition: C
            data:
              - refId: A
                relativeTimeRange:
                  from: 604800
                  to: 0
                datasourceUid: prometheus
                model:
                  expr: |
                    count(
                      count_over_time(
                        certmanager_certificate_ready_status{condition="True"}[7d]
                      ) 
                      and
                      changes(certmanager_certificate_ready_status{condition="True"}[7d]) > 0
                    )
                  refId: A
                  intervalMs: 1000
                  maxDataPoints: 43200
              - refId: B
                relativeTimeRange:
                  from: 0
                  to: 0
                datasourceUid: __expr__
                model:
                  type: math
                  expression: $A
                  refId: B
              - refId: C
                relativeTimeRange:
                  from: 0
                  to: 0
                datasourceUid: __expr__
                model:
                  type: threshold
                  expression: B
                  conditions:
                    - evaluator:
                        params:
                          - 50
                        type: gte
                      operator:
                        type: and
                      query:
                        params:
                          - C
                      type: query
                  refId: C
            noDataState: OK
            execErrState: OK
            for: 1m
            annotations:
              summary: "RATE LIMIT REACHED: New certificates will fail"
              description: |
                **RATE LIMIT REACHED: 50/50 certificates used this week**
                
                **CUSTOMER IMPACT:**
                - ❌ New custom domain requests are FAILING
                - ❌ Customers cannot add whitelabel domains
                - ❌ Business-critical whitelabeling feature is OFFLINE
                
                **Duration:** Up to 7 days from first certificate in rolling window
                
                **Required Actions:**
                1. ✅ Notify all stakeholders (Product, Customer Success, Engineering)
                2. ✅ Update status page with incident
                3. ✅ Prepare customer communication
                4. ✅ Disable new domain creation in UI (if possible)
                5. ✅ Implement request queue for when quota resets
                6. ✅ Plan quota increase request to Let's Encrypt (if eligible)
                
                **Recovery:**
                - Quota resets on rolling 7-day window
                - Monitor for oldest certificate to age out
                - Prepare to process queued requests when quota available
                
                **Post-Incident:**
                - Review quota usage patterns
                - Implement stricter controls on certificate requests
                - Consider Let's Encrypt paid tier or alternative CA
                - Improve domain lifecycle management to reduce churn
              runbook_url: "https://github.com/Copper-IQ/copperiq-monitoring/blob/main/docs/runbooks/letsencrypt-rate-limit.md"
            labels:
              severity: critical
              component: cert-manager
              category: certificates
              business_impact: outage
            isPaused: false
