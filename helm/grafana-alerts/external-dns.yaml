# Grafana Unified Alerting Rules: external-dns
# Converted from PrometheusRule: external-dns-alerts
apiVersion: 1
groups:
  - orgId: 1
    name: external-dns
    folder: applications
    interval: 30s
    rules:
      - uid: externaldnssyncerrors
        title: ExternalDNSSyncErrors
        condition: C
        for: 10m
        noDataState: OK
        execErrState: Alerting
        annotations:
          summary: External-DNS sync errors detected
          description: |
            External-DNS is experiencing errors syncing DNS records to Azure DNS.

            **Error rate**: {{ $value | humanize }} errors/second

            **Impact**: New ingresses may not be reachable, DNS records may drift.

            **Possible causes**:
            1. Azure DNS API issues
            2. Authentication/authorization problems
            3. Rate limiting
            4. Network connectivity

            **Action**:
            1. Check external-dns logs: `kubectl logs -n external-dns -l app.kubernetes.io/name=external-dns --tail=200`
            2. Verify Azure permissions: external-dns needs DNS Zone Contributor role
            3. Check DNS zones in Azure portal for manual changes/locks
            4. Verify workload identity binding is correct
        labels:
          severity: warning
          component: external-dns
          category: platform
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(external_dns_registry_errors_total[5m])
              refId: A
              datasource:
                type: prometheus
                uid: prometheus
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
              datasource:
                type: __expr__
                uid: __expr__
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: math
              expression: $B > 0.1
              refId: C
              datasource:
                type: __expr__
                uid: __expr__
      - uid: externaldnsdown
        title: ExternalDNSDown
        condition: C
        for: 5m
        noDataState: OK
        execErrState: Alerting
        annotations:
          summary: External-DNS controller is down
          description: |
            External-DNS controller is not responding.

            **Impact**:
            - New services won't get DNS records
            - Existing records won't be updated
            - DNS drift from desired state

            **Action**:
            1. Check pods: `kubectl get pods -n external-dns`
            2. Check logs: `kubectl logs -n external-dns -l app.kubernetes.io/name=external-dns --tail=100`
            3. Check events: `kubectl get events -n external-dns --sort-by='.lastTimestamp'`
            4. Restart if needed: `kubectl rollout restart deployment -n external-dns external-dns`
        labels:
          severity: critical
          component: external-dns
          category: platform
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: up{job="external-dns"}
              refId: A
              datasource:
                type: prometheus
                uid: prometheus
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
              datasource:
                type: __expr__
                uid: __expr__
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: math
              expression: $B == 0
              refId: C
              datasource:
                type: __expr__
                uid: __expr__
      - uid: externaldnssourceerrors
        title: ExternalDNSSourceErrors
        condition: C
        for: 10m
        noDataState: OK
        execErrState: Alerting
        annotations:
          summary: External-DNS source discovery errors
          description: >
            External-DNS is failing to discover ingress/service resources.


            **Error rate**: {{ $value | humanize }} errors/second


            **Impact**: Some ingresses may not get DNS records created.


            **Action**:

            1. Check external-dns logs: `kubectl logs -n external-dns -l app.kubernetes.io/name=external-dns | grep -i
            error`

            2. Verify RBAC permissions: external-dns needs to list/watch ingresses and services

            3. Check for malformed ingress annotations

            4. Verify source configuration in external-dns deployment
        labels:
          severity: warning
          component: external-dns
          category: platform
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(external_dns_source_errors_total[5m])
              refId: A
              datasource:
                type: prometheus
                uid: prometheus
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
              datasource:
                type: __expr__
                uid: __expr__
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: math
              expression: $B > 0.1
              refId: C
              datasource:
                type: __expr__
                uid: __expr__
