apiVersion: 1
groups:
  - orgId: 1
    name: content-platform-redis
    folder: Content Platform
    interval: 1m
    rules:
      - uid: content_platform_redis_high_memory
        title: Content Platform - Redis High Memory Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: redis_memory_used_bytes{namespace=~"content-platform-.*"} / redis_memory_max_bytes{namespace=~"content-platform-.*"} * 100
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 80
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 80
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Alerting
        for: 10m
        annotations:
          description: |-
            Redis memory usage is above 80% on {{ $labels.namespace }}
            Current usage: {{ $values.A.Value }}%
            This may lead to evictions and performance degradation
          summary: Redis memory usage is critically high
          runbook_url: https://redis.io/docs/management/optimization/memory-optimization/
        labels:
          severity: warning
          component: redis
          environment: "{{ $labels.namespace }}"
        isPaused: false

      - uid: content_platform_redis_evictions
        title: Content Platform - Redis Evictions Detected
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(redis_evicted_keys_total{namespace=~"content-platform-.*"}[5m])
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: |-
            Redis is evicting keys on {{ $labels.namespace }}
            Eviction rate: {{ $values.A.Value }} keys/sec
            This indicates memory pressure - consider increasing memory limits or reviewing cache TTLs
          summary: Redis evicting keys due to memory pressure
          runbook_url: https://redis.io/docs/management/optimization/memory-optimization/
        labels:
          severity: warning
          component: redis
          environment: "{{ $labels.namespace }}"
        isPaused: false

      - uid: content_platform_redis_low_hit_rate
        title: Content Platform - Redis Low Hit Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 1800
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(redis_keyspace_hits_total{namespace=~"content-platform-.*"}[5m]) / (rate(redis_keyspace_hits_total{namespace=~"content-platform-.*"}[5m]) + rate(redis_keyspace_misses_total{namespace=~"content-platform-.*"}[5m])) * 100
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 80
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 80
                      - 0
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Alerting
        for: 30m
        annotations:
          description: |-
            Redis cache hit rate is below 80% on {{ $labels.namespace }}
            Current hit rate: {{ $values.A.Value }}%
            Low hit rate may indicate inefficient caching strategy or cache warming issues
          summary: Redis cache hit rate is suboptimal
          runbook_url: https://redis.io/docs/management/optimization/memory-optimization/
        labels:
          severity: info
          component: redis
          environment: "{{ $labels.namespace }}"
        isPaused: false

      - uid: content_platform_redis_down
        title: Content Platform - Redis Down
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 60
              to: 0
            datasourceUid: prometheus
            model:
              expr: up{job=~".*redis.*", namespace=~"content-platform-.*"}
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                      - 0
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              refId: C
              type: threshold
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          description: |-
            Redis exporter is down or unreachable on {{ $labels.namespace }}
            This may indicate Redis pod crash or network issues
            IMPACT: Cache and session functionality unavailable
          summary: Redis is down or unreachable
          runbook_url: https://redis.io/docs/management/troubleshooting/
        labels:
          severity: critical
          component: redis
          environment: "{{ $labels.namespace }}"
        isPaused: false
